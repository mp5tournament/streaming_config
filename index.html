<html>
<head>
    <link rel="icon" sizes="32x32" href="https://osu.ppy.sh/images/favicon/favicon-32x32.png">
    <link rel="icon" sizes="16x16" href="https://osu.ppy.sh/images/favicon/favicon-16x16.png">
    <meta charset="utf-8">
    <title>直播配置生成器</title>  
<style>
body{
    background-color:#F3F5F7;
    margin:0;
    font-size:18px;
    line-height: 30px;
}
#body{
    width:830px;
    padding:10px;
    margin: auto;
    background-color:white;
    min-height: 100vh;
}
h1{
    margin-top: 10px;
    margin-bottom: 0px;
    float: left;
}
#introduction{
    margin-top: 25px;
    font-size:10px;
    color:#808080;
    padding: 0;
    float: right;
}
#introduction a{
    display:inline !important;
    color:#808080 !important;
}
#introduction a:hover{
    background-color:white !important;
    color: #A0A0A0 !important;
}
td{
    font-size:18px;
    line-height: 30px;
    vertical-align:top;
}
.title{
    font-size:22px;
    font-weight:bold;
    width:100px;
}
.comment{
    font-size:14px;
}
input{
    width:100px;
    font-size:18px;
    height:30px;
}
.bo input{
    width:56px !important;
    text-align: right;
    float:right;
}
textarea{
    resize:none;
    width:100px;
    font-size:18px;
    height:78px;
    font-family: MicrosoftYaHei;
}
button{
    font-size:18px;
    width:200px;
    height:30px;
}
button.number{
    background-color: #ace;
    font-size:12px;
    width:24px;
    height:24px;
    text-align: center;
    border-radius: 12px;
    padding: 0;
    margin:0 5px;
}
#r,#m{
    vertical-align:middle;
    display: inline-block;
    text-align: center;
    width: 22px;
}
</style>
</head>
<body>
<div id="body">
<div style="height:56px">
    <h1>直播配置生成器</h1>
    <div id="introduction">项目地址：<a href="https://github.com/mp5tournament/streaming_config" target="_blank">https://github.com/mp5tournament/streaming_config</a></div>
</div>
<hr style="margin-top:0">
<table>
    <tr>
        <td class="title">说明</td>
        <td class="comment"><b>本工具可以根据以下填写的信息自动生成osu!直播配置文件“bracket.json”，在按要求填写好以下信息后点击“导出本页直播配置”按钮即可。</b><br
            >也可以不填写任何信息（或仅填写apikey），通过点击“导出最新MP5直播配置”按钮，直接获取最新的MP5杯直播配置文件。<br
            >目前生成的配置文件不包括赛程相关配置，直播员在使用时可直接新建比赛并选择直播场次的队伍和轮次。</td>
    </tr>
    <tr>
        <td></td>
        <td><button id="export">导出本页直播配置</button> <button id="mp5">导出最新MP5直播配置</button></td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">apikey</td>
        <td class="comment"><b>本项可以不填写。</b><br
            >本项为osu!旧版api的apikey。如果你填写了本项，生成的直播配置文件中选手的用户名会被自动转化为uid。<br
            >若你在队伍信息中即使用了uid，或是你不介意生成的配置文件中没有选手uid，则可不填写此项。配置文件中选手没有uid仅有用户名时，选手头像等内容将无法在直播中正确显示，但对于一般使用没有影响。<br
            >请<a href="https://osu.ppy.sh/home/account/edit#legacy-api" target="_blank">点击此处</a>并下滑至页面底部“Legacy API”处获取旧版apikey。</td>
    </tr>
    <tr>
        <td></td>
        <td><input id="apikey" style="width:100%;" placeholder="abcdefghijklmnopqrstuvwxyz01234567890123"></td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">队伍信息</td>
        <td class="comment">请将队名和队员的用户名或uid复制至此处。<br
            >以下每行表示一个队，每行中第一项为队名，之后为队员。每项之间使用制表符（tab，"\t"）分隔。这意味着<b>一般来说你从比赛的主表格中直接复制队伍信息至此处即可。</b><br
            >队员可以使用用户名（username）也可以使用uid，但需统一，即如果你使用用户名，则全部选手均应为用户名，反之亦然。</td>
    </tr>
    <tr>
        <td></td>
        <td><textarea id="team" style="width:100%;height: 102px;"></textarea></td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">图池信息</td>
        <td class="comment">请在此处填写图池信息。<br
            >在表格上方点击按钮增减轮次或图池中不同Mod池的数量。<br
            >在表格中填写图池的具体信息，每列代表一轮图池，每行代表一种Mod。在上方的表头处你可以修改轮次的名称和bo数，在左方的表头处你可以修改Mod池的名称。表格中间的部分请填写相应轮次和Mod池中图的bid，每行一张图。</td>
    </tr>
    <tr>
        <td></td>
        <td>
            轮次数：<button class="number" onclick="changeTable(0,0)">➖</button><span id="r">3</span><button class="number" onclick="changeTable(0,1)" style="margin-right: 30px;">➕</button>
            Mod数：<button class="number" onclick="changeTable(1,0)">➖</button><span id="r">6</span><button class="number" onclick="changeTable(1,1)">➕</button>
        </td>
    </tr>
</table>
<table>
    <tr class="round">
        <td></td>
        <td><input value="第一轮"></td>
        <td><input value="第二轮"></td>
        <td><input value="第三轮"></td>
    </tr>
    <tr class="bo">
        <td></td>
        <td>bo<input value="9" type="number" min="1"></td>
        <td>bo<input value="11" type="number" min="1"></td>
        <td>bo<input value="13" type="number" min="1"></td>
    </tr>
    <tr>
        <td><input value="NM"></td>
        <td><textarea placeholder="1000684
327526"></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="HD"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="HR"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="DT"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="FM"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="TB"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
</table>
</div>
<script type="text/javascript">
const isInteger=/^-?[0-9]*$/
document.getElementById('team').setAttribute('placeholder',
`队名1\tusername1_1\tusername1_2\t...
队名2\tusername2_1\tusername2_2\t...
...
`)
const apikey=document.getElementById('apikey')

function getUserID(players,i,status,retry=2){
    let xhr = new XMLHttpRequest()
    xhr.open('get', `https://osu.ppy.sh/api/get_user?k=${apikey.value.trim()}&u=${players[i]}&type=${apikey.value.trim()?'string':'id'}`)
    xhr.send()
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try{
                if(!xhr.responseText)throw 'blank'
                if(xhr.responseText=='[]'){
                    status.noUser=players[i]
                    return
                }
                let ans=JSON.parse(xhr.responseText)
                if(ans.error){
                    status.apikey=true
                    return
                }
                if(ans[0].user_id){
                    players[i]={id:ans[0].user_id}
                    status.last-=1
                    return
                }
            }catch(e){}
            if(retry)getUserID(players,i,status,retry-1)
            else status.connection=true
        }
    }
}

function checkExport(Rounds,Teams,status){
    if(status.connection){
        alert('未能获取用户id，请确保您提供的apikey有效，并检查网络连接后重试。若不想将用户名转化为uid，请清空apikey。')
        return
    }
    if(status.apikey){
        alert('您提供的apikey无效，请检查后重试。若不想将用户名转化为uid，请清空apikey。')
        return
    }
    if(status.noUser){
        alert(`没有在osu中查找到您提供的用户名“${status.noUser}”，请检查后重试。若不想将用户名转化为uid，请清空apikey。`)
        return
    }
    if(status.last){
        setTimeout(function(){checkExport(Rounds,Teams,status)},500)
        return
    }

    let text=(JSON.stringify({
        Ruleset: {
            ShortName: 'osu',
            Name: 'osu!',
            InstantiationInfo: 'osu.Game.Rulesets.Osu.OsuRuleset, osu.Game.Rulesets.Osu',
            LastAppliedDifficultyVersion: 20220902,
            Available: true
        },
        Matches: [],
        Rounds,
        Teams,
        Progressions: [],
        AutoProgressScreens: true,
        SplitMapPoolByMods: true,
    }))

    //console.log(text)
    //return
    
    const blob = new Blob([text], {
        type: 'text/plain;charset=utf-8'
    })
    const objectURL = URL.createObjectURL(blob)
    const aTag = document.createElement('a')
    aTag.href = objectURL
    aTag.download = 'bracket.json'
    aTag.click()
    URL.revokeObjectURL(objectURL)
}

function exportConfig(Rounds,Teams){
    for(round of Rounds){
        let Beatmaps=[]
        for(mod in round.Beatmaps){
            for(bid of round.Beatmaps[mod]){
                if(!isInteger.test(bid.trim())){
                    alert(`图池“${mod}”中bid“${bid}”格式错误，请检查后重试。`)
                    return
                }
                Beatmaps.push({ID:parseInt(bid),Mods:mod})
            }
        }
        round.Beatmaps=Beatmaps
    }
    let isUsername=false
    let order=[0]
    let l=1
    for(i in Teams){
        let nickname=''
        for(o of order){
            nickname=String.fromCharCode(65+o)+nickname
        }

        try{
            for(j=0;j<=l;j++){
                if(j==l)throw 'overflow'
                order[j]++
                if(order[j]==26)order[j]=0
                else break
            }
        }catch(e){
            order.push(0)
            l++
        }
        let teamLine=Teams[i].split('\t')
        let team={
            FullName:teamLine[0].trim(),
            FlagName:nickname,
            Acronym:nickname,
            Players:[]
        }
        for(j in teamLine)if(j&&teamLine[j].trim()){
            team.Players.push(teamLine[j].trim())
        }
        for(player of team.Players)isUsername=isUsername||!isInteger.test(player)
        Teams[i]=team
    }

    let status={last:0}
    if(isUsername){
        if(apikey.value.trim()){
            function convertID(players,i,p){
                status.last+=1
                setTimeout(getUserID(players,i,status),p*100)
            }
        }else{
            function convertID(players,i,p){
                players[i]={Username:players[i]}
            }
        }
    }else{
        function convertID(players,i,p){
            players[i]={id:players[i]}
        }
    }
    let p=0
    for(team of Teams) for(i in team.Players) convertID(team.Players,i,p++)
    
    checkExport(Rounds,Teams,status)
}

document.getElementById('export').onclick=function(){
    let rounds=[]
    let teamData=document.getElementById('team').value.trim().split('\n')

    console.log(rounds)
    console.log(teamData)
    exportConfig(rounds,teamData)
}
document.getElementById('mp5').onclick=function(){
    let xhr = new XMLHttpRequest()
    xhr.open('get', `https://mp5tournament.github.io/referee_sheet/`)
    //xhr.setRequestHeader("Cache-Control", "no-cache")
    xhr.send()
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status>=200&&xhr.status<400) {
                const tournament={name:null,nickname:null,tbPickable:null,tbPickable:null,tbOnlyOne:null,teamPlayingSize:null,teamData:null,rounds:null,poolMod:null,poolSymbol:null}
                eval(xhr.responseText.split('// 锦标赛设置')[1].split('<\/script>')[0])
                let rounds=[]
                for(roundName in tournament.rounds){
                    let round={BestOf: 0,Beatmaps: tournament.rounds[roundName].pool}
                    round.name=roundName
                    round.Description=roundName
                    for(e of tournament.rounds[roundName].events){
                        if(e=='p')round.BestOf+=2
                        if(e=='t')round.BestOf+=1
                    }
                    rounds.push(round)
                }
                exportConfig(rounds,tournament.teamData)
            } else {
                alert('获取MP5配置失败，请检查连接并重试。')
            }
        }
    }
}

function changeTable(isMod,add) {
    if(isMod){
        if(add){

        }else{

        }
    }else{
        if(add){

        }else{
            
        }
    }
}
</script>
</body>
</html>
