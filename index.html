<html>
<head>
    <link rel="icon" sizes="32x32" href="https://osu.ppy.sh/images/favicon/favicon-32x32.png">
    <link rel="icon" sizes="16x16" href="https://osu.ppy.sh/images/favicon/favicon-16x16.png">
    <meta charset="utf-8">
    <title>直播配置生成器</title>  
<style>
body{
    background-color:#F3F5F7;
    margin:0;
    font-size:18px;
    line-height: 30px;
}
#body{
    width:830px;
    padding:0 10px;
    margin: auto;
    background-color:white;
    min-height: 100vh;
}
h1{
    margin-top: 20px;
    margin-bottom: 0px;
    float: left;
}
#introduction{
    margin-top: 60px;
    line-height: 10px;
    font-size:10px;
    color:#808080;
    padding: 0;
    float: right;
}
#introduction a{
    display:inline !important;
    color:#808080 !important;
}
#introduction a:hover{
    background-color:white !important;
    color: #A0A0A0 !important;
}
td{
    font-size:18px;
    line-height: 30px;
    vertical-align:top;
}
.title{
    font-size:22px;
    font-weight:bold;
    width:100px;
}
.comment{
    font-size:14px;
    color: #55A;
    line-height: 24px;
}
input{
    width:100px;
    font-size:18px;
    height:30px;
}
.bo input{
    width:56px !important;
    text-align: right;
    float:right;
}
textarea{
    resize:none;
    width:100px;
    font-size:18px;
    height:78px;
    font-family: inherit;
}
#export,#mp5{
    font-size:18px;
    width:200px;
    height:30px;
    border-radius: 5px;
}
#mp5{
    background-color:#FBC;
}
#mp5:hover{
    background-color:#FCD;
}
#export{
    background-color:#FD8;
}
#export:hover{
    background-color:#FEA;
}
button.number{
    background-color: #BCF;
    font-size:12px;
    width:24px;
    height:24px;
    text-align: center;
    border-radius: 12px;
    padding: 0;
    margin:0 5px;
}
button.number:hover{
    background-color: #CDF;
}
#r,#m{
    vertical-align:middle;
    display: inline-block;
    text-align: center;
    width: 22px;
}
a{
    color: #66F;
}
a:hover{
    color: #99F;
}
</style>
</head>
<body>
<div id="body">
<div style="height:75px">
    <h1>直播配置生成器</h1>
    <div id="introduction">项目地址：<a href="https://github.com/mp5tournament/streaming_config" target="_blank">https://github.com/mp5tournament/streaming_config</a></div>
</div>
<hr style="margin-top:0">
<table>
    <tr>
        <td class="title">说明</td>
        <td class="comment"><b>本工具可以根据以下填写的信息自动生成osu!直播配置文件“bracket.json”，在按要求填写好以下信息后点击“导出本页直播配置”按钮即可。</b><br
            >也可以不填写任何信息（或仅填写apikey），通过点击“导出最新MP5直播配置”按钮，直接获取最新的MP5杯直播配置文件。<br
            >目前生成的配置文件不包括赛程相关配置，直播员在使用时可直接新建比赛并选择直播场次的队伍和轮次。</td>
    </tr>
    <tr>
        <td></td>
        <td><button id="export">导出本页直播配置</button> <button id="mp5">导出最新MP5直播配置</button></td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">apikey</td>
        <td class="comment" colspan="2"><b>本项可以不填写。</b><br
            >本项为osu!旧版api的apikey。如果你填写了本项，生成的直播配置文件中选手的用户名会被自动转化为uid。<br
            >若你在队伍信息中即使用了uid，或是你不介意生成的配置文件中没有选手uid，则可不填写此项。配置文件中选手没有uid仅有用户名时，选手头像等内容将无法在直播中正确显示，但对于一般使用没有影响。<br
            >请<a href="https://osu.ppy.sh/home/account/edit#legacy-api" target="_blank">点击此处</a>并下滑至页面底部“Legacy API”处获取旧版apikey，它应当是一个仅包含小写字母和数字的字符串。</td>
    </tr>
    <tr>
        <td></td>
        <td style="width:570px"><input id="apikey" style="width:100%;" placeholder="abcdefghijklmnopqrstuvwxyz01234567890123"></td>
        <td><input id="remember" type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">记住apikey</td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">队伍信息</td>
        <td class="comment">请将队名和队员的用户名或uid复制至此处。<br
            >以下每行表示一个队，每行中第一项为队名，之后为队员。每项之间使用制表符（tab，"\t"）分隔。这意味着<b>一般来说你从比赛的主表格中直接复制队伍信息至此处即可。</b><br
            >队员可以使用用户名（username）也可以使用uid，但需统一，即如果你使用用户名，则全部选手均应为用户名，反之亦然。</td>
    </tr>
    <tr>
        <td></td>
        <td><textarea id="team" style="width:100%;height: 102px;"></textarea></td>
    </tr>
</table>
<hr>
<table>
    <tr>
        <td class="title">图池信息</td>
        <td class="comment">请在此处填写图池信息。<br
            >在表格上方点击按钮增减轮次或图池中不同Mod池的数量。<br
            >在表格中填写图池的具体信息，每列代表一轮图池，每行代表一种Mod。在上方的表头处你可以修改轮次的名称和bo数，在左方的表头处你可以修改Mod池的名称。表格中间的部分请填写相应轮次和Mod池中图的BID，每行一张图。</td>
    </tr>
    <tr>
        <td></td>
        <td>
            轮次数：<button class="number" onclick="changeTable(1,0)">➖</button><span id="r">3</span><button class="number" onclick="changeTable(1,1)" style="margin-right: 30px;">➕</button>
            Mod数：<button class="number" onclick="changeTable(0,0)">➖</button><span id="m">6</span><button class="number" onclick="changeTable(0,1)">➕</button>
        </td>
    </tr>
</table>
<table id="pool">
    <tr class="round">
        <td></td>
        <td><input value="第一轮"></td>
        <td><input value="第二轮"></td>
        <td><input value="第三轮"></td>
    </tr>
    <tr class="bo">
        <td></td>
        <td>bo<input value="9" type="number" min="1"></td>
        <td>bo<input value="11" type="number" min="1"></td>
        <td>bo<input value="13" type="number" min="1"></td>
    </tr>
    <tr>
        <td><input value="NM"></td>
        <td><textarea placeholder="NM1的BID
NM2的BID
…"></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="HD"></td>
        <td><textarea placeholder="HD1的BID
HD2的BID
…"></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="HR"></td>
        <td><textarea placeholder="…"></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="DT"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="FM"></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
    <tr>
        <td><input value="TB"></td>
        <td><textarea placeholder="1000684"></textarea></td>
        <td><textarea></textarea></td>
        <td><textarea></textarea></td>
    </tr>
</table>
</div>
<script type="text/javascript">
const isInteger=/^-?[0-9]*$/
document.getElementById('team').setAttribute('placeholder',
`队名1\tusername1_1\tusername1_2\t…
队名2\tusername2_1\tusername2_2\t…
…
`)
const apikey=document.getElementById('apikey')
const remember=document.getElementById('remember')
const pool=document.getElementById('pool').getElementsByTagName('tr')[0].parentNode

if(localStorage.getItem('apikey')) apikey.value=localStorage.getItem('apikey')
if(Boolean(localStorage.getItem('remember'))) remember.checked=true
function saveApikey(){
    if(remember.checked){
        localStorage.setItem('remember',1)
        localStorage.setItem('apikey',apikey.value.trim())
    }else{
        localStorage.removeItem('remember')
        localStorage.removeItem('apikey')
    }
}
remember.onchange=saveApikey

function getUserID(players,i,status,retry=2){
    let xhr = new XMLHttpRequest()
    xhr.open('get', `https://osu.ppy.sh/api/get_user?k=${apikey.value.trim()}&u=${players[i]}&type=${apikey.value.trim()?'string':'id'}`)
    xhr.send()
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try{
                if(!xhr.responseText)throw 'blank'
                if(xhr.responseText=='[]'){
                    status.noUser=players[i]
                    return
                }
                let ans=JSON.parse(xhr.responseText)
                if(ans.error){
                    status.apikey=true
                    return
                }
                if(ans[0].user_id){
                    players[i]={id:ans[0].user_id}
                    status.last-=1
                    return
                }
            }catch{}
            if(retry)getUserID(players,i,status,retry-1)
            else status.connection=true
        }
    }
}

function checkExport(Rounds,Teams,status){
    if(status.connection){
        alert('未能获取用户id，请确保您提供的apikey有效，并检查网络连接后重试。若不想将用户名转化为uid，请清空apikey。')
        return
    }
    if(status.apikey){
        alert('您提供的apikey无效，请检查后重试。若不想将用户名转化为uid，请清空apikey。')
        return
    }
    if(status.noUser){
        alert(`没有在osu中查找到您提供的用户名“${status.noUser}”，请检查后重试。若不想将用户名转化为uid，请清空apikey。`)
        return
    }
    if(status.last){
        setTimeout(function(){checkExport(Rounds,Teams,status)},500)
        return
    }

    let text=(JSON.stringify({
        Ruleset: {
            ShortName: 'osu',
            Name: 'osu!',
            InstantiationInfo: 'osu.Game.Rulesets.Osu.OsuRuleset, osu.Game.Rulesets.Osu',
            LastAppliedDifficultyVersion: 20220902,
            Available: true
        },
        Matches: [],
        Rounds,
        Teams,
        Progressions: [],
        AutoProgressScreens: true,
        SplitMapPoolByMods: true,
    }))
    
    const blob = new Blob([text], {
        type: 'text/plain;charset=utf-8'
    })
    const objectURL = URL.createObjectURL(blob)
    const aTag = document.createElement('a')
    aTag.href = objectURL
    aTag.download = 'bracket.json'
    aTag.click()
    URL.revokeObjectURL(objectURL)
}

function exportConfig(Rounds,Teams){
    for(let round of Rounds){
        let Beatmaps=[]
        for(let mod in round.Beatmaps){
            for(let bid of round.Beatmaps[mod]){
                if(!isInteger.test(bid.trim())){
                    alert(`图池“${mod}”中bid“${bid}”格式错误，请检查后重试。`)
                    return
                }
                Beatmaps.push({ID:parseInt(bid),Mods:mod})
            }
        }
        round.Beatmaps=Beatmaps
    }
    let isUsername=false
    let order=[0]
    let l=1
    for(let i in Teams){
        let nickname=''
        for(let o of order){
            nickname=String.fromCharCode(65+o)+nickname
        }

        try{
            for(let j=0;j<=l;j++){
                if(j==l)throw 'overflow'
                order[j]++
                if(order[j]==26)order[j]=0
                else break
            }
        }catch{
            order.push(0)
            l++
        }
        let teamLine=Teams[i].split('\t')
        let team={
            FullName:teamLine[0].trim(),
            FlagName:nickname,
            Acronym:nickname,
            Players:[]
        }
        for(let j in teamLine)if(j!='0'&&teamLine[j].trim()){
            team.Players.push(teamLine[j].trim())
        }
        for(let player of team.Players)isUsername=isUsername||!isInteger.test(player)
        Teams[i]=team
    }

    let status={last:0}
    if(isUsername){
        if(apikey.value.trim()){
            function convertID(players,i,p){
                status.last+=1
                setTimeout(function(){getUserID(players,i,status)},p*100)
            }
        }else{
            function convertID(players,i,p){
                players[i]={Username:players[i]}
            }
        }
    }else{
        function convertID(players,i,p){
            players[i]={id:players[i]}
        }
    }
    let p=0
    for(let team of Teams) for(let i in team.Players) convertID(team.Players,i,p++)
    
    checkExport(Rounds,Teams,status)
}

document.getElementById('export').onclick=function(){
    saveApikey()
    let teamData=document.getElementById('team').value.trim().split('\n')
    let rounds=[]
    for(let tr of pool.getElementsByTagName('tr')){
        if(tr.classList.contains('round')){
            for(let input of tr.getElementsByTagName('input')){
                let name=input.value.trim()
                if(!name){
                    alert('轮次名称不能为空，请检查后重试。')
                    return
                }
                let round={name,Description:name,Beatmaps:{}}
                rounds.push(round)
            }
        }else if(tr.classList.contains('bo')){
            let i=0
            for(let input of tr.getElementsByTagName('input')){
                let bo=Number(input.value)
                if(bo%1){
                    alert('bo数不能为小数，请检查后重试。')
                    return
                }
                if(bo<=0){
                    alert('bo数必须为正数，请检查后重试。')
                    return
                }
                rounds[i].BestOf=bo
                i++
            }
        }else{
            let mod=tr.getElementsByTagName('input')[0].value.trim()
            if(!mod){
                alert('Mod名称不能为空，请检查后重试。')
                return
            }
            let i=0
            for(let textarea of tr.getElementsByTagName('textarea')){
                let bidText=textarea.value.trim()
                if(bidText)rounds[i].Beatmaps[mod]=bidText.split('\n')
                i++
            }
        }
    }
    exportConfig(rounds,teamData)
}
document.getElementById('mp5').onclick=function(){
    saveApikey()
    let xhr = new XMLHttpRequest()
    xhr.open('get', `https://mp5tournament.github.io/referee_sheet/`)
    xhr.setRequestHeader("Cache-Control", "no-cache")
    xhr.send()
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status>=200&&xhr.status<400) {
                const tournament={name:null,nickname:null,tbPickable:null,tbPickable:null,tbOnlyOne:null,teamPlayingSize:null,teamData:null,rounds:null,poolMod:null,poolSymbol:null}
                eval(xhr.responseText.split('// 锦标赛设置')[1].split('<\/script>')[0])
                let rounds=[]
                for(let roundName in tournament.rounds){
                    let round={BestOf: 0,Beatmaps: tournament.rounds[roundName].pool}
                    round.name=roundName
                    round.Description=roundName
                    for(let e of tournament.rounds[roundName].events){
                        if(e=='p')round.BestOf+=2
                        if(e=='t')round.BestOf+=1
                    }
                    rounds.push(round)
                }
                exportConfig(rounds,tournament.teamData)
            } else {
                alert('获取MP5配置失败，请检查连接并重试。')
            }
        }
    }
}

const chinese=['','一','二','三','四','五','六','七','八','九']
function toChinese(r){
    if(r<10) return chinese[r]
    if(r<20) return '十'+chinese[r%10]
    if(r<100) return chinese[(r-r%10)/10]+'十'+chinese[r%10]
    if(r==100) return '一百'
    return r
}

let r=3
let m=6
const _TR=pool.getElementsByTagName('tr')[5].cloneNode(true)
_TR.getElementsByTagName('input')[0].value=''
const _TD=_TR.getElementsByTagName('td')[1].cloneNode(true)
const _TD0=pool.getElementsByTagName('tr')[0].getElementsByTagName('td')[1].cloneNode(true)
function changeTable(isRound,add) {
    if(isRound){
        if(add){
            document.getElementById('r').textContent=++r
            for(let tr of pool.getElementsByTagName('tr')){
                if(tr.classList.contains('round')){
                    _TD0.getElementsByTagName('input')[0].value=`第${toChinese(r)}轮`
                    tr.appendChild(_TD0.cloneNode(true))
                }else if(tr.classList.contains('bo')){
                    tr.appendChild(tr.lastElementChild.cloneNode(true))
                }else{
                    tr.appendChild(_TD.cloneNode(true))
                }
            }
            _TR.appendChild(_TD.cloneNode(true))
        }else{
            if(r<=1)return
            document.getElementById('r').textContent=--r
            for(let tr of pool.getElementsByTagName('tr')){
                tr.removeChild(tr.lastElementChild)
            }
            _TR.removeChild(_TR.lastElementChild)
        }
    }else{
        if(add){
            document.getElementById('m').textContent=++m
            pool.appendChild(_TR.cloneNode(true))
        }else{
            if(m<=1)return
            document.getElementById('m').textContent=--m
            pool.removeChild(pool.lastElementChild)
        }
    }
}
</script>
</body>
</html>
